<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chat WebSocket Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        #container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            color: #1a1a1a;
        }
        .control-group, .chat-group {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fdfdfd;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.2s;
        }
        #btnConnect { background-color: #28a745; color: white; }
        #btnConnect:hover { background-color: #218838; }
        #btnDisconnect { background-color: #dc3545; color: white; }
        #btnDisconnect:hover { background-color: #c82333; }
        #btnSend { background-color: #007bff; color: white; }
        #btnSend:hover { background-color: #0069d9; }
        #btnMarkRead { background-color: #ffc107; color: #212529; }
        #btnMarkRead:hover { background-color: #e0a800; }

        #messages {
            list-style-type: none;
            padding: 0;
            margin: 0;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        #messages li {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        #messages li:nth-child(odd) {
            background-color: #e9ecef;
        }
        .status {
            font-size: 12px;
            font-family: monospace;
            padding: 5px;
            background: #eee;
            border-radius: 3px;
            display: inline-block;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>

<div id="container">
    <h2>WebSocket Chat Tester</h2>

    <div class="control-group">
        <h3>1. K·∫øt n·ªëi (Authentication)</h3>
        <label for="token">JWT Access Token (Kh√¥ng bao g·ªìm "Bearer "):</label>
        <input type="text" id="token" placeholder="D√°n access token c·ªßa b·∫°n v√†o ƒë√¢y...">
        <br/><br/>
        <button id="btnConnect">K·∫øt n·ªëi</button>
        <button id="btnDisconnect" disabled>Ng·∫Øt k·∫øt n·ªëi</button>
        <br/><br/>
        <div id="status">Tr·∫°ng th√°i: <span class="status" style="color: #dc3545;">üî¥ CH∆ØA K·∫æT N·ªêI</span></div>
    </div>

    <div class="chat-group">
        <h3>2. G·ª≠i v√† Nh·∫≠n Tin nh·∫Øn</h3>
        <label for="conversationId">Conversation ID:</label>
        <input type="number" id="conversationId" placeholder="Nh·∫≠p ID cu·ªôc h·ªôi tho·∫°i (v√≠ d·ª•: 123)">

        <br/><br/>
        <label for="message">N·ªôi dung tin nh·∫Øn:</label>
        <input type="text" id="message" placeholder="Nh·∫≠p tin nh·∫Øn...">

        <br/><br/>
        <button id="btnSend" disabled>G·ª≠i tin nh·∫Øn (sendMessage)</button>
        <button id="btnMarkRead" disabled>ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc (markAsRead)</button>
    </div>

    <div class="chat-group">
        <h3>3. Log Tin Nh·∫Øn Nh·∫≠n ƒê∆∞·ª£c</h3>
        <ul id="messages">
        </ul>
    </div>
</div>

<script>
    // Khai b√°o c√°c bi·∫øn
    let stompClient = null;
    let currentConversationId = null;

    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnSend = document.getElementById('btnSend');
    const btnMarkRead = document.getElementById('btnMarkRead');
    const tokenInput = document.getElementById('token');
    const conversationIdInput = document.getElementById('conversationId');
    const messageInput = document.getElementById('message');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');

    // G√°n s·ª± ki·ªán cho c√°c n√∫t
    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', disconnect);
    btnSend.addEventListener('click', sendMessage);
    btnMarkRead.addEventListener('click', markAsRead);

    function updateStatus(message, isConnected) {
        let color = isConnected ? '#28a745' : '#dc3545';
        let icon = isConnected ? 'üü¢' : 'üî¥';
        statusEl.innerHTML = `Tr·∫°ng th√°i: <span class="status" style="color: ${color};">${icon} ${message}</span>`;

        btnConnect.disabled = isConnected;
        btnDisconnect.disabled = !isConnected;
        btnSend.disabled = !isConnected;
        btnMarkRead.disabled = !isConnected;
    }

    function logMessage(message) {
        const li = document.createElement('li');
        li.textContent = message;
        messagesEl.appendChild(li);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ==========================================================
    // S·ª¨A H√ÄM CONNECT - KH√îNG D√ôNG SOCKJS
    // ==========================================================
    function connect(event) {
        event.preventDefault();
        const token = tokenInput.value;
        currentConversationId = conversationIdInput.value;

        if (!token || !currentConversationId) {
            alert('Vui l√≤ng nh·∫≠p JWT Token v√† Conversation ID.');
            return;
        }

        updateStatus('ƒêANG K·∫æT N·ªêI...', false);

        // Kh·ªüi t·∫°o StompJs.Client
        stompClient = new StompJs.Client({
            brokerURL: 'ws://localhost:3000/ws',

            connectHeaders: {
                'Authorization': `Bearer ${token}`
            },

            // B·∫≠t debug ƒë·ªÉ xem log tr√™n Console
            debug: (str) => {
                console.log('STOMP Debug: ' + str);
            },

            // 3. Callback khi k·∫øt n·ªëi th√†nh c√¥ng
            onConnect: (frame) => {
                updateStatus('ƒê√É K·∫æT N·ªêI!', true);
                logMessage('--- K·∫øt n·ªëi th√†nh c√¥ng t·ªõi server ---');

                // 4. Subscribe v√†o topic c·ªßa cu·ªôc h·ªôi tho·∫°i
                const topic = `/topic/conversation/${currentConversationId}`;
                stompClient.subscribe(topic, (message) => {
                    logMessage(`Nh·∫≠n t·ª´ ${topic}: ${message.body}`);

                    try {
                        const msgDTO = JSON.parse(message.body);
                        if (msgDTO.content) {
                            logMessage(`[Msg from ${msgDTO.senderName}]: ${msgDTO.content}`);
                        } else {
                            // C√≥ th·ªÉ l√† tin nh·∫Øn "ƒë√£ ƒë·ªçc"
                            logMessage(`[Event]: ${message.body}`);
                        }
                    } catch (e) {
                        logMessage(`[Raw]: ${message.body}`);
                    }
                });

                logMessage(`--- ƒê√£ subscribe v√†o topic: ${topic} ---`);
            },

            // 5. Callback khi c√≥ l·ªói STOMP (v√≠ d·ª•: token sai)
            onStompError: (frame) => {
                updateStatus('L·ªñI K·∫æT N·ªêI', false);
                const errorMessage = frame.headers['message'] || 'Kh√¥ng r√µ l·ªói';
                logMessage(`L·ªói STOMP: ${errorMessage}`);
                console.error('L·ªói STOMP: ', frame.body);
            },

            // Callback khi WebSocket b·ªã l·ªói (v√≠ d·ª•: kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server)
            onWebSocketError: (error) => {
                updateStatus('L·ªñI WEBSOCKET', false);
                logMessage(`L·ªói WebSocket: ${error.message}`);
                console.error('L·ªói WebSocket: ', error);
            }
        });

        // 6. K√≠ch ho·∫°t k·∫øt n·ªëi
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient !== null) {
            // D√πng deactivate() cho v7
            stompClient.deactivate();
            stompClient = null; // Quan tr·ªçng: set l·∫°i l√† null
            updateStatus('ƒê√É NG·∫ÆT K·∫æT N·ªêI', false);
            logMessage('--- ƒê√£ ng·∫Øt k·∫øt n·ªëi ---');
        }
    }

    // ==========================================================
    // S·ª¨A H√ÄM SENDMESSAGE THEO STOMPJS v7
    // ==========================================================
    function sendMessage() {
        const content = messageInput.value;
        if (!content || !stompClient || !stompClient.connected) {
            alert('Ch∆∞a k·∫øt n·ªëi ho·∫∑c ch∆∞a nh·∫≠p tin nh·∫Øn!');
            return;
        }

        const destination = '/app/chat.sendMessage';
        const payload = {
            conversationId: parseInt(currentConversationId),
            content: content
        };

        // D√πng .publish() thay v√¨ .send()
        stompClient.publish({
            destination: destination,
            body: JSON.stringify(payload)
        });

        logMessage(`--- G·ª≠i ƒë·∫øn ${destination}: ${JSON.stringify(payload)} ---`);
        messageInput.value = ''; // X√≥a n·ªôi dung input
    }

    // H√†m markAsRead c·ªßa b·∫°n ƒë√£ ƒë√∫ng c√∫ ph√°p v7 (d√πng publish)
    function markAsRead() {
        if (!stompClient || !stompClient.connected) {
            alert('Chua k·∫øt n·ªëi!');
            return;
        }

        const destination = '/app/chat.markAsRead';
        const payload = {
            conversationId: parseInt(currentConversationId)
            // B·∫°n c√≥ th·ªÉ c·∫ßn th√™m messageId cu·ªëi c√πng ·ªü ƒë√¢y
        };

        stompClient.publish({
            destination: destination,
            body: JSON.stringify(payload)
        });

        logMessage(`--- G·ª≠i ƒë·∫øn ${destination}: ${JSON.stringify(payload)} ---`);
    }

</script>
</body>
</html>